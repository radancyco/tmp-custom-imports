@using Tmp.TalentBrew.Core
@using Tmp.TalentBrew.Model
@model PublishedCustomHTMLModuleModel
@using Tmp.TalentBrew.Core.HtmlHelpers


@{
    var publishedContentPages = Html.GetPublishedContentPages();

    /* ======================= */
    /* WILL THERE BE MORE THAN ONE HUB ON THE PAGE? 1 = Yes / 0 = no */ 
    /* ======================= */

    int moreThanOneHub = 0;
    
    /* If there is more than One HUB on the page you need to
    /* update the following 2 answers to be unique on the page */

    /* ======================= */
    /* ID FOR THIS HUB - Should always be data-hub-variable just update the number */
    /* ======================= */
    var thisHubID = "data-hub-1";

    /* ======================= */
    /* IN ONE WORD DESCRIBE THE HUB - if there is only one HUB on the page leave blank */
    /* If there is more than one HUB on the page describe this HUB for example you might have a "Main" and a "Featured" */
    /* ======================= */
    var descriptionOfHub = "";


    /* ======================= */
    /* NEEDED FOR TRACKING: DO NOT MODIFY */ 
    /* ======================= */

    var trackingHubName = "HUB";

    if(moreThanOneHub == 1){
        trackingHubName = "HUB-" + descriptionOfHub;
    }

    /* ======================= */
    /* BASE FACETS: DO NOT MODIFY */ 
    /* ======================= */
    var customFacetFieldNames = new List<string>();
    customFacetFieldNames.Add("Campaign");
    customFacetFieldNames.Add("Company Name");
    customFacetFieldNames.Add("Industry");
    customFacetFieldNames.Add("Is Manager");
    customFacetFieldNames.Add("Is Telecommute");
    customFacetFieldNames.Add("Job Level");
    customFacetFieldNames.Add("Job Status");
    customFacetFieldNames.Add("Job Type");
    customFacetFieldNames.Add("Travel");
    customFacetFieldNames.Add("Hours Per Week");
    customFacetFieldNames.Add("Salary Relocation");
    customFacetFieldNames.Add("Salary Time");

    /* ======================= */
    /* ADD ANY CUSTOM FACETS YOU MAY NEED */
    /* ======================= */
    @* customFacetFieldNames.Add("ContentType"); *@

    /* ======================= */
    /* INCLUDE FILTER BY FORM */
    /* ======================= */
    /* 1 = True / 0 = False */
    int showFilterForm = 1;
    
    /* ======================= */
    /* INCLUDE FILTER BY BUTTONS */
    /* ======================= */
    int showFilterButtons = 0;

    /* ======================= */
    /* Filter options */
    /* ======================= */
     /* FILTER WEIGHTED OR EXACT MATCH  (1 = Weighted Match / 0 = Exact Match) */
    int filterWeighted = 1;

    /* ======================= */
    /* QUERY FILTERS */
    /* ======================= */
    /* SHOW ONLY PAGES WITH IMAGES (1 = True / 0 = False) */
    int imagesOnly = 1;
    /* SHOW CONTENT PAGE TYPE PAGES (1 = True / 0 = False) */
    int contentPageType = 1;
    /* SHOW SELF-SERVICE PAGE TYPE PAGES (1 = True / 0 = False) */
    int selfServicePageType = 1;
    /* SHOW ONLY EXTERNAL PAGES (1 = True / 0 = False) */
    int externalPagesOnly = 0;

    /* ======================= */
    /* PRE-FILTERS */
    /* ======================= */
    int usePreFilter = 0;
    int keepMappings = 1;

    /* ======================= */
    /* SORTING */
    /* ======================= */
    /* DEFAULT SORT ON LOAD (1 = Sort by date / 0 = False) */
    int sort = 1;
    /* SORT CRITERIA (Must be name of data attriubute found on the item to sort by) */
    string sortCriteria = "data-hub-date-updated";
    /* DATE SORT DIRECTION (0 = random / 1 = Descending / 2 = Ascending) */
    int sortDirection = 1;

    
    /* ======================= */
    /* HOW MANY TO SHOW ON LOAD AND HOW MANY TO SHOW PER CLICK */
    /* ======================= */
    /* NUMBER OF RECORDS TO SHOW BEFORE MORE BUTTON (0 disables "more" feature) */
    int moreDefaultCount = 9;
    /* NUMBER OF RECORDS TO SHOW WHEN CLICKING MORE (0 will show all) */
    int moreButtonCount = 3;
    /* MAX NUMBER OF RECORDS ABLE TO BE SHOW (0 will be no limit) */
    int moreMaxCount = 0;
    
    /* ======================= */
    /* HOW MANY FLEX COLUMNS */
    /* ======================= */
    /* NUMBER OF COLUMNS USING THE DEFAULT STYLES (0 through 6 columns, 0 makes it not flexed and you can ignore default styles) */
    int systemStyledColumns = 3;

    /* ======================= */
    /* RECOMMENDED IMAGE SIZE */
    /* ======================= */
    /* SIZE OF SPACER UNTIL IMAGE IS LOADED: Make sure to update the Theme settings with matching data. Theme > Image Settings > Related Content */
    /* DO NOT add px after the number */
    int lazyWidth = 600; 
    int lazyHeight = 338;

    /* ======================= */
    /* ERROR AND ARIA MESSAGES */
    /* ======================= */
    /* NO RESULTS FOUND TEXT (Error and Aria) */
    string noResults = "No results found, please try picking another combination of filters.";
    /* RESULTS FOUND WHEN CLICK ON A FILTER OR REST (Aria - will have a number read infront of this string.) */
    string resultsFound = "Results found.";
    /* LOAD MORE BUTTON MESSAGE (Aria - will have a number read infront of this string.) */
    string loadedMsg = "new items have been loaded.";
    /* NO MORE TO LOAD MESSAGE (Aria - will have a number read infront of this string.) */
    string finishedMsg = "new items have been loaded and all results are now showing.";

    /* ======================= */
    /* EXTERNAL LINK CONTROLS */
    /* ======================= */
    /* DO EXTERNAL LINKS NEED TO OPEN IN A NEW WINODW? (1 = Yes / 0 = No) */
    int opensNewWidnow = 0;
    /* This text comes after the title */
    string ariaWarning = "opens in new window";


}

    @* ======================= *@
    @* HELPER: BUILD FILTERS ON PAGE *@
    @* ======================= *@
    @helper addFilter(string selectLabel, string selectFieldName, string selectDefaultText, int selectShow, string currentHub) {
        if(selectShow == 1){
            <div class="hub-filter__select-wrapper">
                <label class="hub-filter__label hub-visually-hidden" for="@currentHub-@selectFieldName">@selectLabel</label>
                <select class="hub-filter__select" id="@currentHub-@selectFieldName" data-hub-id="@currentHub"><option class="hub-filter__option" value="none">@selectDefaultText</option></select>
            </div>
        }
    }
    
    @* ======================= *@
    @* HELPER: PREFILTER ITEMS ON PAGE *@
    @* ======================= *@
    @helper addPreFilters(string cat, string loc, string fName, string fValue, string currentHub) {
    var thisFacet = "";
    var thisLoc = "";
    var thisCat = "";
        if(fName != "ALL"){
            thisFacet = "[" + @currentHub + "-facet-" + @fName + "='" + @fValue + "']";
        }
        if(loc != "ALL"){
            thisLoc = "[" + @currentHub + "-location='" + @loc + "']";
        }
        if(cat != "ALL"){
            thisCat = "[" + @currentHub + "-category='" + @cat + "']";
        }
        <li class="js-hub-prefilter" data-query="@thisCat@thisLoc@thisFacet"></li>
    }
     
    @* ======================= *@
    @* HELPER: YOUR FILTER BY BUTTONS *@
    @* ======================= *@
    @helper addfilterButton(string cat, string loc, string fName, string fValue, string buttonLabel, string currentHub, string trackingHubName) {
        var thisString = "";
        if(fName != "ALL"){
            thisString = "[" + @currentHub + "-facet-" + @fName + "='" + @fValue + "']";
        }
        <li class="hub-filter-btn__item">
            <button class="js-hub-filter-button js-tb-click-tracking hub-filter-btn__button" data-query="[@currentHub-category='@cat'][@currentHub-location='@loc']@thisString" data-hub-id="@currentHub" data-custom-category="@trackingHubName-Filter" data-custom-label="@buttonLabel">@buttonLabel</button>
        </li>
    }


     
    @* ======================= *@
    @* HELPER: MAPPINGS FOR ARTICLES *@
    @* ======================= *@
    @helper addMapping(string categoryValue, string locationValue , string facetName, string facetValue, string currentHub) {
        if(facetName == ""){
            <li @currentHub-category="@categoryValue" @currentHub-location="@locationValue"></li>
        }else{
            <li @currentHub-category="@categoryValue" @currentHub-location="@locationValue" @currentHub-facet-@facetName="@facetValue"></li>
        }
    }
     
    
<section class="js-hub hub__wrapper" 
        id="@thisHubID" 
        data-show-form="@showFilterForm" 
        data-prefilter="@usePreFilter"
        data-keepmappings="@keepMappings"
        data-load-more-default="@moreDefaultCount" 
        data-load-more-amount="@moreButtonCount"
        data-load-more-max="@moreMaxCount"
        data-no-results-text="@noResults"
        data-results-found-text="@resultsFound">
        @if(usePreFilter == 1){
            <ul class="hub-prefilter" aria-hidden="true">
                @* ======================= *@
                @* PREFILTER SETUP: (Category, Location, Facet Name, Facet Value, Current Hub) *@
                @* Please provide a value of ALL for cateogry, location, facet name and facet value if they are unused *@
                @* CORRECTION asof 8/29 you must put in a facet value *@
                @* ======================= *@
                
                @addPreFilters("Medical Services","New York, NY (City)","job-type","Full Time",thisHubID)
                @addPreFilters("Account Services","ALL","ALL","ALL",thisHubID)
            </ul>
        }

        @if(showFilterButtons == 1){
            @* ======================= *@
            @* FILTER BY BUTTON SETUP: For each filter button you want to apply send (Category, Location, Facet Name, Facet Value, Label of Button, Current Hub, Tracking vairble) *@
            @* Please provide a value of ALL for cateogry, location, facet name and facet value if they are unused *@
            @* ======================= *@
            <div class="js-hub-filter-button-wrapper hub-filter-btn__wrapper">
                <h2 class="hub-filter-btn__heading">Filter Buttons</h2>
                <ul class="hub-filter-btn__list">
                    <li class="hub-filter-btn__item"><button class="js-hub-filter-button-reset js-hub-filter-button js-tb-click-tracking hub-filter-btn__button current-active" data-hub-id="@thisHubID" data-custom-category="@trackingHubName-Filter" data-custom-label="Show All">Show All</button></li>
                @addfilterButton("Medical Services","New York, NY (City)","job-type","Full Time","Medical (NYC/Full-Time)",thisHubID,trackingHubName)
                @addfilterButton("Account Services","ALL","ALL","ALL","Account Services (Global)",thisHubID,trackingHubName)
                </ul>
            </div>
        }

        
        @if(showFilterForm == 1){
            <form class="js-hub-filter-form hub-filter">
                <fieldset class="hub-filter__fieldset">
                    <legend class="hub-filter__heading">Filter stories</legend>
                    <div class="hub-filter__controls">
                        @* ======================= *@
                        @* Creating filters (Label, field, default value, Hide/Show, ID) *@
                        @* ======================= *@
                        @addFilter("Content Type","facet-contenttype","Select Content Type",1, thisHubID)
                        @addFilter("Category","category","Select Category",1, thisHubID)
                        @addFilter("Location","location","Select Location",1, thisHubID)
                        @addFilter("Is-telecommute","facet-is-telecommute","Select Is telecommute",1, thisHubID)
                        @addFilter("Campaign","facet-campaign","Select Campaign",1, thisHubID)
                        @addFilter("Company Name","facet-companyname","Select Company Name",1, thisHubID)
                        @addFilter("Industry","facet-industry","Select Industry",1, thisHubID)
                        @addFilter("Is Manager","facet-is-manager","Select Is Manager",1, thisHubID)
                        @addFilter("Division","facet-job-level","Select Division",1, thisHubID)
                        @addFilter("Job Status","facet-job-status","Select Job Status",1, thisHubID)
                        @addFilter("Job Type","facet-job-type","Select Job Type",1, thisHubID)
                        @addFilter("Travel","facet-travel","Select Travel",1, thisHubID)
                        @addFilter("Hours Per Week","facet-hours-per-week","Select Hours Per Week",1, thisHubID)
                        @addFilter("Salary Relocation","facet-salary-relocation","Select Salary Relocation",1, thisHubID)
                        @addFilter("Salary Time","facet-salary-time","Select Salary Time",1, thisHubID)
                        <button class="js-hub-submit-filters hub-filter__button" data-hub-id="@thisHubID" data-custom-category="@trackingHubName-Filter">Filter</button>
                        <button class="js-hub-reset-filters js-tb-click-tracking hub-filter__button" data-hub-id="@thisHubID" data-custom-category="@trackingHubName-Filter" data-custom-label="Reset">Reset</button>
                    </div>
                </fieldset>
            </form>
        }
        <ul class="js-hub-content hub-content__list" 
            data-sort="@sort" 
            data-filter-weight="@filterWeighted" 
            data-sort-criteria="@sortCriteria"
            data-sort-direction="@sortDirection"
            data-system-css-columns="@systemStyledColumns">
            @foreach (var contentPage in publishedContentPages){
                var pageCreated = contentPage.IsCmsCreated ? "SS created" : "TMP created";
                int externalPage = 1;
                if ( contentPage.PageUrl.Split('/').Last().ToString().Length != 0 ) {
                    externalPage = 0;
                }
                string ariaAttr = "";
                if( externalPage == 1 && opensNewWidnow == 1) { 
                    ariaAttr = "target=\"_blank\" rel=\"noopener\" aria-label=\"" + @contentPage.Title + " (" + ariaWarning + ")\"";
                }
                if( ( imagesOnly == 1 && @contentPage.ThumbnailFilePath != "" || imagesOnly != 1 ) && 
                    ( externalPagesOnly == 1 && externalPage == 1 || externalPagesOnly != 1 ) &&
                    ( pageCreated == "SS created" && selfServicePageType == 1 || pageCreated == "TMP created" && contentPageType == 1 ) ){     

                    @* ========================== *@
                    @* Exclusions *@
                    @* ========================== *@
                    string compareExclude = contentPage.LinkUrl;
                    int run;
                    switch(compareExclude){
                        case "/example-exclusion-url":
                            run = 0;
                            break;
                        default:
                            run = 1;
                            break;
                    }
                    
                    if(run == 1){
                        if (contentPage.KeywordPageMappings != null && contentPage.KeywordPageMappings.Any()){
                            int v = 0;
                            var ltype = "";
                            var lltype = "";
                            var eLinkClass = "";
                            <li class="js-hub-item hub-content__item showing-by-filter"
                                data-hub-origin="@contentPage.IsCmsCreated"  
                                data-hub-title="@contentPage.Title"  
                                data-hub-meta="@contentPage.Description" 
                                data-hub-url="@contentPage.PageUrl" 
                                data-hub-link="@contentPage.LinkUrl" 
                                data-hub-image="@contentPage.ThumbnailFilePath" 
                                data-hub-created-by="@pageCreated" 
                                data-hub-date-updated="@contentPage.DateUpdated" 
                                data-hub-date-created="@contentPage.DateCreated">
                                
                                @* ========================== *@
                                @* Content to return for each record *@
                                @* ========================== *@
                                @if(contentPage.LinkUrl.Contains("youtube")){
                                    ltype = "video-link youtube";
                                } else if(contentPage.LinkUrl.Contains("vimeo")){
                                    ltype = "video-link vimeo";
                                } else if(contentPage.LinkUrl.Contains(".mp4")){
                                    ltype = "video-link mp4";
                                }
                                @if( externalPage == 1 ) {
                                    eLinkClass = "external-link";
                                }
                                
                                @*// Example of adding a class to the link based on custom facet *@
                                @foreach (var mapping in contentPage.KeywordPageMappings){
                                    if(customFacetFieldNames.Contains(mapping.CustomFacetFieldName)){
                                        if( mapping.CustomFacetFieldValueDisplay == "video" || mapping.CustomFacetFieldValueDisplay == "Video" ){
                                            lltype = "video-type";
                                        }
                                    }
                            }
                                @*
                                    // You can rearange all of the items inside the a tag however since the link is targeted via 
                                    // js it needs to remain around all the item content 
                                *@
                                <a href="@contentPage.LinkUrl" class="js-hub-item-link js-tb-click-tracking hub-item__link @ltype @lltype @eLinkClass" data-custom-category="@trackingHubName-ContentPage" data-custom-label="@contentPage.Title" @Html.Raw(ariaAttr)>
                                    <div class="hub-item__image-wrapper">
                                        <img class="js-hub-lazy hub-item__image" data-src="@contentPage.ThumbnailFilePath" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 @lazyWidth @lazyHeight'%3E%3C/svg%3E" alt="">
                                    </div>
                                    <div class="hub-item__text">
                                        <span class="hub-item__title">@contentPage.Title</span>
                                        <span class="hub-item__description">
                                            @contentPage.Description
                                            <span class="hub-item__fake-button">Learn More</span>
                                        </span>
                                        
                                    </div>
                                </a>
                                
                                @* ========================== *@
                                @* Required for filtering *@
                                @* ========================== *@
                                <ul class="js-hub-mappings hidden" aria-hidden="true">
                                    @foreach (var mapping in contentPage.KeywordPageMappings){
                                        var cat = mapping.CategoryDisplay;
                                        var loc = mapping.LocationDisplay;
                                        if(customFacetFieldNames.Contains(mapping.CustomFacetFieldName)){
                                            var fName = mapping.CustomFacetFieldNameDisplay.Replace(" ", "-");
                                            var fValue = mapping.CustomFacetFieldValueDisplay;
                                            @addMapping(cat, loc, fName , fValue, thisHubID);
                                        } else{
                                            @addMapping(cat, loc, "IGNORE", "", thisHubID);
                                        }                                    
                                    }
                                </ul>
                            </li>
                        }
                    }
                    
                }
            }
        </ul>    
        @if( moreDefaultCount > 0 || showFilterForm == 1 || showFilterButtons == 1 ) {
            <div class="hub__bottom-nav">
                @if(moreDefaultCount > 0){
                    <button class="js-hub-load-more-button js-tb-click-tracking hub__load-more-button disabled" data-hub-id="@thisHubID"  data-custom-category="@trackingHubName" data-custom-label="Load More" data-items-loaded-msg="@loadedMsg" data-items-finished-msg="@finishedMsg">Load more</button>
                }
                @if(showFilterForm == 1 || showFilterButtons == 1){
        
                    <button class="js-hub-back-to-button js-tb-click-tracking hub__back-to-button" data-hub-id="@thisHubID" data-custom-category="@trackingHubName" data-custom-label="Jump back to filters">Back to filters</button>
                }
            </div>
        }
        <div class="js-aria-hub-msg hub-visually-hidden" aria-live="polite"></div>
</section>